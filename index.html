<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Compressor - V14 (ES Modules)</title>
    
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 600px; width: 100%; background: #1e293b; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .upload-box { 
            border: 2px dashed #6366f1; padding: 40px; text-align: center; cursor: pointer; 
            border-radius: 8px; margin-bottom: 20px; transition: 0.3s; background: rgba(99, 102, 241, 0.1); font-weight: bold;
        }
        .upload-box:hover { background: rgba(99, 102, 241, 0.2); }

        .controls { opacity: 0.5; pointer-events: none; transition: 0.3s; }
        .controls.active { opacity: 1; pointer-events: all; }

        input[type=range] { width: 100%; margin: 10px 0 20px 0; accent-color: #8b5cf6; }
        
        button {
            background: #8b5cf6; color: white; border: none; padding: 15px; width: 100%;
            border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer;
        }
        button:hover { background: #7c3aed; }

        #log-box { 
            width: 100%; height: 100px; background: #000; color: #00ff00; 
            font-family: monospace; font-size: 11px; padding: 10px; 
            border: 1px solid #333; margin-top: 20px; overflow-y: scroll; box-sizing: border-box;
        }
        
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 999;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
            border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s infinite linear;
        }
        @keyframes spin { to {transform: rotate(360deg);} }

        #preview-img { max-width: 100%; margin-top: 20px; border: 1px solid #333; display: none; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

</head>
<body>

<div id="overlay">
    <div class="spinner"></div>
    <h3 style="margin-top:20px">Procesando...</h3>
</div>

<div class="container">
    <h2>GIF OPTIMIZER V14 (Modules)</h2>
    
    <input type="file" id="fileIn" accept="image/gif" hidden>
    <div class="upload-box" id="drop-zone">
        üìÇ SUBIR GIF AQU√ç
    </div>

    <div class="controls" id="ctrls">
        <label>ESCALA: <span id="v-scale">70%</span></label>
        <input type="range" id="rng-scale" min="30" max="100" value="70">
        
        <label>CALIDAD (10): <span id="v-qual">10</span></label>
        <input type="range" id="rng-qual" min="1" max="20" value="10">
        
        <button id="btn-process">üöÄ PROCESAR</button>
    </div>

    <img id="preview-img" src="">
    <div id="stats" style="margin-top:10px; font-weight:bold; color:#22c55e;"></div>
    
    <button id="btn-dl" style="display:none; margin-top:10px; background:#22c55e">‚¨áÔ∏è DESCARGAR</button>

    <div id="log-box">Iniciando sistema moderno...</div>
</div>

<script type="module">
    // IMPORTAMOS EL LECTOR DIRECTAMENTE COMO M√ìDULO (Esto no puede fallar por nombres globales)
    import { parseGIF, decompressFrames } from 'https://cdn.skypack.dev/gifuct-js';

    // VARIABLES
    let originalFile = null;
    let parsedFrames = [];
    let workerUrl = null;
    let resultBlob = null;

    // ELEMENTOS UI
    const logBox = document.getElementById('log-box');
    const fileIn = document.getElementById('fileIn');
    const dropZone = document.getElementById('drop-zone');
    const btnProcess = document.getElementById('btn-process');
    const btnDl = document.getElementById('btn-dl');

    // LOGGING
    function log(msg) {
        logBox.innerHTML = `> ${msg}<br>` + logBox.innerHTML;
    }

    // INICIALIZACI√ìN
    log("‚úÖ Sistema de M√≥dulos iniciado.");
    
    // Preparar Worker (Ya sabemos que esto te funciona)
    async function setupWorker() {
        try {
            const resp = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
            const txt = await resp.text();
            const blob = new Blob([txt], {type: 'application/javascript'});
            workerUrl = URL.createObjectURL(blob);
            log("‚úÖ Worker cargado en memoria.");
        } catch(e) {
            log("‚ö†Ô∏è Fall√≥ carga de worker local. Se intentar√° remoto.");
        }
    }
    setupWorker();

    // LISTENERS
    dropZone.onclick = () => fileIn.click();
    
    document.getElementById('rng-scale').oninput = (e) => {
        document.getElementById('v-scale').innerText = e.target.value + "%";
    }
    document.getElementById('rng-qual').oninput = (e) => {
        document.getElementById('v-qual').innerText = e.target.value;
    }

    // MANEJO DE ARCHIVO
    fileIn.onchange = (e) => {
        if(!e.target.files[0]) return;
        originalFile = e.target.files[0];
        log(`üìÇ Archivo: ${originalFile.name}`);

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                // AQU√ç USAMOS LAS FUNCIONES IMPORTADAS
                const gif = parseGIF(event.target.result);
                parsedFrames = decompressFrames(gif, true);
                
                log(`‚úÖ Frames le√≠dos: ${parsedFrames.length}`);
                document.getElementById('ctrls').classList.add('active');
            } catch(err) {
                log(`‚ùå Error Lector: ${err.message}`);
                alert("Error al leer el GIF.");
            }
        };
        reader.readAsArrayBuffer(originalFile);
    };

    // PROCESAMIENTO
    btnProcess.onclick = () => {
        document.getElementById('overlay').style.display = 'flex';
        setTimeout(runEngine, 100);
    };

    function runEngine() {
        try {
            const scale = parseInt(document.getElementById('rng-scale').value) / 100;
            const quality = parseInt(document.getElementById('rng-qual').value);
            
            // Configurar GIF.js (Este viene del script global antiguo, que s√≠ funcion√≥)
            const gifConfig = {
                workers: 2,
                quality: quality,
                width: parsedFrames[0].dims.width * scale,
                height: parsedFrames[0].dims.height * scale,
                transparent: 'rgba(0,0,0,0)'
            };
            if(workerUrl) gifConfig.workerScript = workerUrl;

            const gif = new GIF(gifConfig);

            // Canvas setup
            const canvas = document.createElement('canvas');
            canvas.width = gifConfig.width;
            canvas.height = gifConfig.height;
            const ctx = canvas.getContext('2d');

            const temp = document.createElement('canvas');
            const tctx = temp.getContext('2d');

            log(`Procesando ${parsedFrames.length} cuadros...`);

            parsedFrames.forEach(frame => {
                temp.width = frame.dims.width;
                temp.height = frame.dims.height;
                const imgData = new ImageData(frame.patch, frame.dims.width, frame.dims.height);
                tctx.putImageData(imgData, 0, 0);

                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(temp, 0, 0, canvas.width, canvas.height);

                gif.addFrame(ctx, {copy: true, delay: frame.delay});
            });

            gif.on('finished', (blob) => {
                resultBlob = blob;
                const url = URL.createObjectURL(blob);
                const img = document.getElementById('preview-img');
                img.src = url;
                img.style.display = 'block';
                
                const saved = ((originalFile.size - blob.size) / originalFile.size * 100).toFixed(0);
                document.getElementById('stats').innerText = `Peso Final: ${(blob.size/1024).toFixed(1)} KB (Ahorro: ${saved}%)`;
                
                btnDl.style.display = 'block';
                document.getElementById('overlay').style.display = 'none';
                log("‚ú® √âXITO.");
            });

            gif.render();

        } catch(e) {
            document.getElementById('overlay').style.display = 'none';
            log(`‚ùå ERROR: ${e.message}`);
            alert(e.message);
        }
    }

    // DESCARGA
    btnDl.onclick = () => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(resultBlob);
        a.download = 'optimizado.gif';
        a.click();
    };
</script>

</body>
</html>
