<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Compressor - GitHub Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/gifuct-js@2.1.2/dist/gifuct-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        
        .container { background: #1e293b; width: 100%; max-width: 600px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center; }
        
        h1 { margin: 0 0 10px 0; background: linear-gradient(90deg, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        p { color: #94a3b8; margin-bottom: 25px; font-size: 14px; }

        .upload-btn {
            background: rgba(255,255,255,0.05); border: 2px dashed #6366f1; border-radius: 10px;
            padding: 40px; cursor: pointer; transition: 0.2s; color: #a5b4fc; font-weight: bold;
        }
        .upload-btn:hover { background: rgba(99, 102, 241, 0.1); border-color: #a78bfa; }

        .controls { margin-top: 25px; text-align: left; opacity: 0.5; pointer-events: none; transition: 0.3s; }
        .controls.active { opacity: 1; pointer-events: all; }
        
        label { font-size: 12px; font-weight: bold; color: #cbd5e1; display: block; margin-bottom: 5px; }
        input[type=range] { width: 100%; margin-bottom: 20px; accent-color: #f472b6; }

        button {
            background: #6366f1; color: white; border: none; padding: 15px; width: 100%;
            border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer;
            transition: 0.2s;
        }
        button:hover { transform: scale(1.02); background: #4f46e5; }
        button:disabled { background: #475569; cursor: not-allowed; }

        .preview { margin-top: 20px; background: #000; border-radius: 8px; overflow: hidden; min-height: 200px; display: flex; align-items: center; justify-content: center; border: 1px solid #334155; }
        .preview img { max-width: 100%; }

        /* LOG Y CARGA */
        #log {
            background: #000; color: #00ff00; font-family: monospace; font-size: 11px;
            padding: 10px; border-radius: 6px; margin-top: 20px; height: 100px;
            overflow-y: scroll; text-align: left; border: 1px solid #333;
        }

        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
            border-top-color: #f472b6; border-radius: 50%; animation: spin 1s infinite linear;
        }
        @keyframes spin { to {transform: rotate(360deg);} }
    </style>
</head>
<body>

<div id="overlay">
    <div class="spinner"></div>
    <h3 style="margin-top:20px">Procesando...</h3>
    <p>No cierres la pesta√±a</p>
</div>

<div class="container">
    <h1>GIF OPTIMIZER</h1>
    <p>Reduce peso sin perder transparencia</p>

    <div class="upload-btn" onclick="document.getElementById('fileIn').click()">
        üìÅ CLIC PARA SUBIR GIF
        <input type="file" id="fileIn" accept="image/gif" hidden onchange="handleFile(this)">
    </div>

    <div class="controls" id="ctrl-panel">
        <label>TAMA√ëO (ESCALA): <span id="val-scale">70%</span></label>
        <input type="range" id="rng-scale" min="10" max="100" value="70" oninput="updateUI()">

        <label>CALIDAD (1=MEJOR, 30=PEOR): <span id="val-qual">10</span></label>
        <input type="range" id="rng-qual" min="1" max="30" value="10" oninput="updateUI()">

        <button onclick="startProcess()" id="btn-run">üöÄ REDUCIR PESO</button>
    </div>

    <div class="preview" id="preview-box">
        <span style="color:#475569">Vista previa</span>
    </div>
    
    <div id="results" style="display:none; margin-top:10px; display:flex; justify-content:space-between; font-size:12px;">
        <span id="res-size"></span>
        <span id="res-save" style="color:#4ade80"></span>
    </div>

    <button id="btn-dl" style="display:none; margin-top:15px; background:#10b981" onclick="download()">‚¨áÔ∏è DESCARGAR</button>

    <div id="log">Estado: Esperando archivo...</div>
</div>

<script>
    let originalFile = null;
    let originalFrames = [];
    let resultBlob = null;
    let workerUrl = null;

    function log(msg) {
        const l = document.getElementById('log');
        l.innerHTML += `<div>> ${msg}</div>`;
        l.scrollTop = l.scrollHeight;
    }

    function updateUI() {
        document.getElementById('val-scale').innerText = document.getElementById('rng-scale').value + "%";
        document.getElementById('val-qual').innerText = document.getElementById('rng-qual').value;
    }

    function handleFile(input) {
        if(!input.files[0]) return;
        const file = input.files[0];
        
        if(file.type !== 'image/gif') { log("‚ùå Error: No es un GIF"); return; }
        
        originalFile = file;
        log(`üìÇ Archivo: ${file.name} (${(file.size/1024).toFixed(2)} KB)`);
        
        // Preview inicial
        document.getElementById('preview-box').innerHTML = `<img src="${URL.createObjectURL(file)}">`;
        
        // Leer Frames
        log("‚è≥ Analizando frames...");
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const gif = parseGIF(e.target.result);
                originalFrames = gif.decompressFrames(true);
                log(`‚úÖ Frames detectados: ${originalFrames.length}`);
                
                // Activar controles
                document.getElementById('ctrl-panel').classList.add('active');
                
                // PRE-CARGAR EL WORKER (El truco para que no falle)
                prepareWorker();
                
            } catch(err) {
                log(`‚ùå Error analizando GIF: ${err.message}`);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // ESTA ES LA CLAVE: Descargar el c√≥digo del worker y crear un Blob local
    async function prepareWorker() {
        log("‚öôÔ∏è Cargando motor de compresi√≥n...");
        try {
            const resp = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
            if(!resp.ok) throw new Error("No se pudo conectar con CDN");
            const workerCode = await resp.text();
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            workerUrl = URL.createObjectURL(blob);
            log("‚úÖ Motor listo para usar.");
        } catch(err) {
            log(`‚ùå Error cr√≠tico cargando motor: ${err.message}`);
            alert("Error de conexi√≥n con la librer√≠a GIF. Revisa tu internet.");
        }
    }

    function startProcess() {
        if(!workerUrl) { alert("El motor a√∫n no carga. Espera 2 segundos."); return; }
        
        document.getElementById('overlay').style.display = 'flex';
        log("üöÄ Iniciando proceso...");
        
        // Peque√±o delay para que la UI se actualice
        setTimeout(processGIF, 100);
    }

    function processGIF() {
        try {
            const scale = parseInt(document.getElementById('rng-scale').value) / 100;
            const quality = parseInt(document.getElementById('rng-qual').value);
            
            const gif = new GIF({
                workers: 2,
                quality: quality,
                width: originalFrames[0].dims.width * scale,
                height: originalFrames[0].dims.height * scale,
                workerScript: workerUrl, // Usamos el blob local
                transparent: 'rgba(0,0,0,0)'
            });

            // Canvas temporal
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            // Procesar cada frame
            originalFrames.forEach((frame, i) => {
                // Dibujar frame original
                tempCanvas.width = frame.dims.width;
                tempCanvas.height = frame.dims.height;
                const imgData = new ImageData(frame.patch, frame.dims.width, frame.dims.height);
                tempCtx.putImageData(imgData, 0, 0);

                // Escalar
                canvas.width = frame.dims.width * scale;
                canvas.height = frame.dims.height * scale;
                
                // Limpiar y dibujar
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);

                // A√±adir al GIF
                gif.addFrame(ctx, {copy: true, delay: frame.delay});
            });

            gif.on('finished', (blob) => {
                resultBlob = blob;
                const url = URL.createObjectURL(blob);
                
                document.getElementById('preview-box').innerHTML = `<img src="${url}">`;
                document.getElementById('overlay').style.display = 'none';
                
                const sizeKB = (blob.size/1024).toFixed(2);
                const saved = ((originalFile.size - blob.size) / originalFile.size * 100).toFixed(0);
                
                log(`‚ú® Terminado! Nuevo peso: ${sizeKB} KB`);
                
                document.getElementById('res-size').innerText = `Peso: ${sizeKB} KB`;
                document.getElementById('res-save').innerText = `Ahorro: ${saved}%`;
                document.getElementById('btn-dl').style.display = 'block';
                document.getElementById('results').style.display = 'flex';
            });

            log(`Renderizando ${originalFrames.length} cuadros...`);
            gif.render();

        } catch(err) {
            document.getElementById('overlay').style.display = 'none';
            log(`‚ùå Error durante el proceso: ${err.message}`);
            alert("Fall√≥ la conversi√≥n. Revisa el registro negro abajo.");
        }
    }

    function download() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(resultBlob);
        a.download = 'optimizado.gif';
        a.click();
    }
</script>

</body>
</html>
