<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Compressor - Tanque V9</title>
    
    <script src="https://cdn.jsdelivr.net/npm/gifuct-js@2.1.2/dist/gifuct-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/antimatter15/jsgif@master/LZWEncoder.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/antimatter15/jsgif@master/NeuQuant.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/antimatter15/jsgif@master/GIFEncoder.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/antimatter15/jsgif@master/b64.js"></script>

    <style>
        body { background: #111; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        .box { background: #222; padding: 30px; border-radius: 10px; max-width: 500px; width: 100%; text-align: center; border: 1px solid #444; }
        
        button {
            background: #ff0055; color: white; border: none; padding: 15px; width: 100%;
            font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 15px;
        }
        button:disabled { background: #555; cursor: wait; }

        .preview { margin-top: 20px; border: 2px solid #555; min-height: 150px; display: flex; align-items: center; justify-content: center; background: #000; }
        .preview img { max-width: 100%; }

        input[type=range] { width: 100%; accent-color: #ff0055; }
        
        #log { color: #0f0; font-family: monospace; font-size: 12px; margin-top: 10px; text-align: left; height: 100px; overflow-y: auto; background: #000; padding: 5px; border: 1px solid #333; }
        
        .warn { color: #fbbf24; font-size: 12px; margin-top: 5px; background: rgba(251, 191, 36, 0.1); padding: 5px; }
    </style>
</head>
<body>

<div class="box">
    <h2>GIF REDUCER (MODO SEGURO)</h2>
    <p style="color:#aaa; font-size:14px;">Esta versión congela la pantalla mientras trabaja para evitar errores de seguridad.</p>

    <input type="file" id="fileIn" accept="image/gif" style="margin-bottom: 20px;">
    
    <label>TAMAÑO: <span id="v-scale">50%</span></label>
    <input type="range" id="rng-scale" min="10" max="80" value="50" oninput="document.getElementById('v-scale').innerText=this.value+'%'">
    
    <button onclick="startSafeProcess()" id="btn-run">REDUCIR PESO</button>
    
    <div id="log">Esperando archivo...</div>
    <div class="warn">⚠️ Si el GIF es muy pesado, la página se congelará unos segundos. No la cierres.</div>

    <div class="preview" id="result-box"></div>
    <div id="stats" style="margin-top:10px; font-weight:bold;"></div>
    
    <button id="btn-dl" style="display:none; background:#00d26a;" onclick="download()">DESCARGAR</button>
</div>

<script>
    let originalFile = null;
    let frames = [];
    let resultBlob = null;

    function log(msg) {
        const l = document.getElementById('log');
        l.innerHTML = `> ${msg}<br>` + l.innerHTML;
    }

    document.getElementById('fileIn').addEventListener('change', function(e) {
        if(!e.target.files[0]) return;
        originalFile = e.target.files[0];
        log(`Cargado: ${originalFile.name}`);
        
        // Carga rápida
        const reader = new FileReader();
        reader.onload = function(event) {
            const gif = parseGIF(event.target.result);
            frames = gif.decompressFrames(true);
            log(`✅ Frames leídos: ${frames.length}`);
        };
        reader.readAsArrayBuffer(originalFile);
    });

    function startSafeProcess() {
        if(!frames.length) { alert("Sube un GIF primero"); return; }
        
        const btn = document.getElementById('btn-run');
        btn.disabled = true;
        btn.innerText = "PROCESANDO (ESPERA...)";
        log("⏳ Iniciando proceso sincrónico...");

        // Usamos setTimeout para que el navegador alcance a actualizar el texto del botón antes de congelarse
        setTimeout(() => {
            try {
                runEncoder();
            } catch(e) {
                alert("Error: " + e.message);
                btn.disabled = false;
            }
        }, 100);
    }

    function runEncoder() {
        const scale = parseInt(document.getElementById('rng-scale').value) / 100;
        
        // 1. Iniciar Encoder (Librería Vieja pero Segura)
        const encoder = new GIFEncoder();
        encoder.setRepeat(0); 
        encoder.setDelay(frames[0].delay);
        encoder.setQuality(15); // Calidad media/baja para velocidad
        encoder.start();

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const temp = document.createElement('canvas');
        const tctx = temp.getContext('2d');

        log(`Procesando ${frames.length} cuadros... (La pantalla se congelará)`);

        for(let i=0; i<frames.length; i++) {
            let frame = frames[i];
            
            // Dibujar frame original
            temp.width = frame.dims.width;
            temp.height = frame.dims.height;
            let imgData = new ImageData(frame.patch, frame.dims.width, frame.dims.height);
            tctx.putImageData(imgData, 0, 0);

            // Escalar
            canvas.width = frame.dims.width * scale;
            canvas.height = frame.dims.height * scale;
            
            // Limpiar canvas
            ctx.fillStyle = "rgb(255,255,255)"; // Fondo blanco para evitar basura negra
            ctx.fillRect(0,0,canvas.width, canvas.height); 
            ctx.drawImage(temp, 0, 0, canvas.width, canvas.height);

            // Agregar al GIF
            encoder.addFrame(ctx);
        }

        encoder.finish();
        
        // Convertir a Blob
        const binary = encoder.stream().getData();
        const array = new Uint8Array(new ArrayBuffer(binary.length));
        for(let i=0; i<binary.length; i++) { array[i] = binary.charCodeAt(i); }
        resultBlob = new Blob([array], {type: 'image/gif'});

        // Mostrar
        const url = URL.createObjectURL(resultBlob);
        document.getElementById('result-box').innerHTML = `<img src="${url}">`;
        
        // Stats
        const saved = ((originalFile.size - resultBlob.size) / originalFile.size * 100).toFixed(0);
        document.getElementById('stats').innerHTML = `Nuevo peso: ${(resultBlob.size/1024).toFixed(1)} KB (Ahorro: ${saved}%)`;

        document.getElementById('btn-dl').style.display = 'block';
        document.getElementById('btn-run').disabled = false;
        document.getElementById('btn-run').innerText = "REDUCIR PESO";
        log("✅ TERMINADO.");
    }

    function download() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(resultBlob);
        a.download = 'lite.gif';
        a.click();
    }
</script>

</body>
</html>
