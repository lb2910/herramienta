<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Upscaler 4X Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --text: #f8fafc; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        
        .app-container {
            display: grid; grid-template-columns: 280px 1fr; width: 95vw; max-width: 1200px; height: 90vh;
            background: var(--panel); border-radius: 16px; overflow: hidden;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.7); border: 1px solid #334155;
        }

        /* SIDEBAR */
        .sidebar { padding: 25px; border-right: 1px solid #334155; display: flex; flex-direction: column; gap: 20px; z-index: 10; background: var(--panel); }
        .logo { font-size: 1.2rem; font-weight: 900; color: #fff; letter-spacing: 1px; margin-bottom: 10px; display:flex; align-items:center; gap:10px; }
        
        .upload-zone {
            border: 2px dashed #475569; border-radius: 12px; height: 100px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: rgba(255,255,255,0.02); transition: 0.3s;
        }
        .upload-zone:hover { border-color: var(--accent); background: rgba(56, 189, 248, 0.1); }
        .upload-zone input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* CONTROLES */
        .control-group { background: #0f172a; padding: 15px; border-radius: 10px; border: 1px solid #334155; }
        .lbl { font-size: 0.75rem; font-weight: 700; color: #94a3b8; display: flex; justify-content: space-between; margin-bottom: 8px; }
        
        /* BOTONES */
        .btn-magic {
            margin-top: auto; padding: 16px; border: none; border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), #0284c7);
            color: white; font-weight: 800; font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.3s; opacity: 0.5; pointer-events: none;
        }
        .btn-magic.ready { opacity: 1; pointer-events: auto; }
        .btn-magic:hover { transform: translateY(-2px); box-shadow: 0 10px 30px -5px rgba(56, 189, 248, 0.5); }

        /* VISOR PRINCIPAL */
        .viewport { position: relative; background: #020617; display: flex; align-items: center; justify-content: center; background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 20px 20px; overflow: hidden; }
        
        .compare-wrapper {
            position: relative; max-width: 95%; max-height: 95%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); border: 2px solid #475569; border-radius: 4px;
            display: none; cursor: ew-resize; user-select: none;
        }
        
        /* Imágenes superpuestas */
        .img-base { display: block; max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none; }
        .img-overlay {
            position: absolute; top: 0; left: 0; height: 100%; width: 50%;
            overflow: hidden; border-right: 3px solid var(--accent);
            background: #020617; /* Evita transparencias */
        }
        .img-overlay img { height: 100%; width: auto; max-width: none; }

        /* Etiquetas */
        .badge { position: absolute; bottom: 10px; padding: 5px 10px; background: rgba(0,0,0,0.8); color: white; font-size: 0.7rem; font-weight: 700; border-radius: 4px; pointer-events: none; }
        .badge-orig { left: 10px; color: #ef4444; border-left: 3px solid #ef4444; }
        .badge-ai { right: 10px; color: var(--accent); border-right: 3px solid var(--accent); }

        /* Loader */
        .loader-overlay {
            position: absolute; inset: 0; background: rgba(15,23,42,0.95);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 50;
        }
        .progress-bar { width: 300px; height: 6px; background: #334155; border-radius: 10px; margin-top: 20px; overflow: hidden; }
        .fill { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }
        
        .console-log { position: absolute; bottom: 20px; font-family: monospace; font-size: 0.7rem; color: #64748b; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="logo"><i class="fas fa-bolt"></i> UPSCALER PRO</div>
        
        <div class="upload-zone">
            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #64748b; margin-bottom: 10px;"></i>
            <span style="font-size: 0.7rem; font-weight: 700; color: #cbd5e1;">SUBIR IMAGEN</span>
            <input type="file" accept="image/*" onchange="loadFile(this)">
        </div>

        <div class="control-group">
            <div class="lbl">
                <span>ESTADO DEL MOTOR</span>
                <span id="ai-status" style="color: #fbbf24;">Cargando...</span>
            </div>
            <div style="font-size: 0.7rem; color: #64748b; line-height: 1.4; margin-top: 5px;">
                Usando modelo GANS 4x con post-procesamiento de nitidez.
            </div>
        </div>

        <div class="control-group">
            <div class="lbl"><span>NITIDEZ EXTRA</span> <span id="shp-val">Alto</span></div>
            <input type="range" id="sharpness" min="0" max="2" step="1" value="2" style="width:100%;" oninput="updateSharpLabel()">
        </div>

        <button id="btn-process" class="btn-magic" onclick="runAI()">
            <i class="fas fa-magic"></i> MEJORAR 400%
        </button>
        
        <button id="btn-dl" class="btn-magic" onclick="downloadResult()" style="display:none; background: #334155;">
            <i class="fas fa-download"></i> DESCARGAR
        </button>
    </div>

    <div class="viewport">
        <div id="placeholder" style="text-align:center; opacity:0.3;">
            <i class="fas fa-image" style="font-size:5rem; margin-bottom:20px;"></i>
            <div>ESPERANDO ARCHIVO</div>
        </div>

        <div class="compare-wrapper" id="compare-box" onmousemove="moveSlider(event)" ontouchmove="moveSlider(event)">
            <img id="img-after" class="img-base" src="">
            <div class="badge badge-ai">IA ULTRA SHARP</div>

            <div class="img-overlay" id="overlay">
                <img id="img-before" src="">
                <div class="badge badge-orig">ORIGINAL</div>
            </div>
        </div>

        <div class="loader-overlay" id="loader">
            <i class="fas fa-circle-notch fa-spin" style="font-size: 3rem; color: var(--accent);"></i>
            <div style="font-weight: 700; font-size: 1.2rem; margin-top: 15px; color: #fff;">PROCESANDO...</div>
            <div id="loader-txt" style="font-size: 0.8rem; color: #94a3b8; margin-top: 5px;">Calentando motores...</div>
            <div class="progress-bar"><div class="fill" id="prog-bar"></div></div>
            <div class="console-log" id="console-txt"></div>
        </div>
    </div>
</div>

<canvas id="hidden-canvas" style="display:none;"></canvas>

<script type="module">
    // IMPORTACIÓN SEGURA PARA GITHUB PAGES
    import Upscaler from 'https://cdn.jsdelivr.net/npm/upscaler@0.22.0/+esm';

    let upscaler = null;
    let originalImg = null;
    let resultUrl = null;

    // --- 1. INICIALIZAR IA AUTOMÁTICAMENTE ---
    (async () => {
        try {
            updateStatus("Cargando Modelos...", "#fbbf24");
            
            // Configuración segura
            upscaler = new Upscaler({
                model: DefaultUpscalerJSModel,
            });

            // Calentamiento (Warmup) para evitar congelamiento en el primer uso
            await upscaler.warmup([{patchSize:32, padding:2}]);
            
            updateStatus("LISTO ✅", "#4ade80");
            
            // Si el usuario ya subió foto mientras cargaba
            if(originalImg) document.getElementById('btn-process').classList.add('ready');

        } catch (e) {
            console.error(e);
            updateStatus("Error de Red ❌", "#ef4444");
            alert("No se pudo cargar la IA. Revisa tu conexión.");
        }
    })();

    // --- 2. FUNCIONES UI (Globales) ---
    window.updateSharpLabel = () => {
        const v = document.getElementById('sharpness').value;
        const txt = v == 0 ? "Apagado" : v == 1 ? "Medio" : "Alto (Recomendado)";
        document.getElementById('shp-val').innerText = txt;
    }

    window.updateStatus = (msg, color) => {
        const el = document.getElementById('ai-status');
        el.innerText = msg;
        el.style.color = color;
    }

    window.loadFile = (input) => {
        if (!input.files[0]) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                originalImg = img;
                
                // Configurar visor inicial (Antes vs Antes)
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('compare-box').style.display = 'block';
                document.getElementById('img-after').src = img.src;
                document.getElementById('img-before').src = img.src;
                
                // Activar botón si IA lista
                if(upscaler) document.getElementById('btn-process').classList.add('ready');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    window.moveSlider = (e) => {
        const box = document.getElementById('compare-box');
        const rect = box.getBoundingClientRect();
        let x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        x = x - rect.left;
        
        let p = (x / rect.width) * 100;
        p = Math.max(0, Math.min(100, p));
        document.getElementById('overlay').style.width = p + '%';
    }

    // --- 3. LÓGICA DE PROCESAMIENTO (EL SECRETO) ---
    window.runAI = async () => {
        if(!upscaler || !originalImg) return;

        const loader = document.getElementById('loader');
        const txt = document.getElementById('loader-txt');
        const bar = document.getElementById('prog-bar');
        const log = document.getElementById('console-txt');
        
        loader.style.display = 'flex';
        document.getElementById('btn-process').classList.remove('ready');

        try {
            txt.innerText = "Fase 1: Reconstrucción IA (GANS)...";
            
            // --- PASO A: IA UPSCALE (Por trozos para no colgarse) ---
            // patchSize: 48 es seguro. padding: 3 evita bordes raros entre trozos.
            const upscaledSrc = await upscaler.upscale(originalImg, {
                patchSize: 48, 
                padding: 3,
                progress: (amount) => {
                    const p = Math.round(amount * 80); // 80% del proceso es la IA
                    bar.style.width = p + "%";
                    log.innerText = `Analizando detalles: ${p}%`;
                }
            });

            // --- PASO B: MEJORA DE NITIDEZ (Post-Processing) ---
            txt.innerText = "Fase 2: Aplicando Nitidez HD...";
            bar.style.width = "90%";
            
            // Pausa técnica para liberar CPU
            await new Promise(r => setTimeout(r, 100));

            const sharpLevel = parseInt(document.getElementById('sharpness').value);
            const finalImageSrc = await applySharpening(upscaledSrc, sharpLevel);

            // --- FINALIZAR ---
            bar.style.width = "100%";
            txt.innerText = "¡Completado!";
            
            // Mostrar resultado en el comparador
            // img-before (Arriba) = Original (escalada por el navegador, se ve borrosa)
            // img-after (Fondo) = IA Resultado (se ve nítida)
            
            // Primero escalamos la original para que coincida en tamaño visualmente
            const tempCanvas = document.createElement('canvas');
            const resImg = new Image();
            resImg.onload = () => {
                // Preparar "Antes" (Borrosa)
                tempCanvas.width = resImg.width; 
                tempCanvas.height = resImg.height;
                const ctx = tempCanvas.getContext('2d');
                ctx.drawImage(originalImg, 0, 0, resImg.width, resImg.height);
                
                document.getElementById('img-before').src = tempCanvas.toDataURL();
                document.getElementById('img-after').src = finalImageSrc;
                
                resultUrl = finalImageSrc; // Guardar para descarga

                setTimeout(() => {
                    loader.style.display = 'none';
                    document.getElementById('btn-process').style.display = 'none';
                    document.getElementById('btn-dl').style.display = 'flex';
                    document.getElementById('btn-dl').classList.add('ready');
                    
                    // Mover slider al 50%
                    document.getElementById('overlay').style.width = '50%';
                }, 500);
            };
            resImg.src = finalImageSrc;

        } catch (err) {
            console.error(err);
            loader.style.display = 'none';
            alert("Error: Memoria insuficiente. Intenta con una imagen más pequeña.");
        }
    }

    window.downloadResult = () => {
        const a = document.createElement('a');
        a.href = resultUrl;
        a.download = "Imagen_Mejorada_4X.png";
        a.click();
    }

    // --- ALGORITMO DE NITIDEZ (UNSHARP MASK) ---
    // Esto es lo que quita la sensación de "solo agrandado"
    function applySharpening(src, level) {
        return new Promise(resolve => {
            if(level === 0) { resolve(src); return; } // Si está apagado, devuelve directo

            const img = new Image();
            img.onload = () => {
                const cvs = document.getElementById('hidden-canvas');
                const ctx = cvs.getContext('2d');
                cvs.width = img.width;
                cvs.height = img.height;

                // 1. Dibujar imagen base
                ctx.drawImage(img, 0, 0);

                // 2. Extraer datos
                const imgData = ctx.getImageData(0, 0, cvs.width, cvs.height);
                const data = imgData.data;
                const buff = new Uint8ClampedArray(data); // buffer lectura
                const w = cvs.width;
                const h = cvs.height;

                // Intensidad
                let strength = level === 1 ? 0.5 : 1.2; // 1.2 es bastante fuerte (crisp)

                // Convolución rápida
                // No procesamos los bordes extremos para ganar velocidad
                for(let y=1; y<h-1; y++) {
                    for(let x=1; x<w-1; x++) {
                        const i = (y*w + x)*4;
                        
                        // Kernel:
                        //  0 -1  0
                        // -1  5 -1
                        //  0 -1  0
                        
                        // Solo aplicamos a RGB
                        for(let c=0; c<3; c++) {
                            const val = buff[i+c];
                            const neighbors = buff[i-w*4+c] + buff[i+w*4+c] + buff[i-4+c] + buff[i+4+c];
                            const sharp = (val * 5) - neighbors;
                            
                            // Mezcla
                            data[i+c] = (sharp * strength) + (val * (1 - strength));
                        }
                    }
                }
                
                ctx.putImageData(imgData, 0, 0);
                resolve(cvs.toDataURL('image/png'));
            };
            img.src = src;
        });
    }
</script>
</body>
</html>
