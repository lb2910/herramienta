<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borrador Mágico IA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #f472b6; --text: #f8fafc; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        .container { display: grid; grid-template-columns: 260px 1fr; width: 95vw; max-width: 1100px; height: 90vh; background: var(--panel); border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #334155; }
        
        .sidebar { padding: 20px; border-right: 1px solid #334155; display: flex; flex-direction: column; gap: 20px; }
        .title { font-weight: 900; font-size: 1.2rem; color: #fff; letter-spacing: 1px; }
        
        .upload-box {
            border: 2px dashed #475569; border-radius: 12px; height: 100px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: rgba(255,255,255,0.02); transition: 0.3s;
        }
        .upload-box:hover { border-color: var(--accent); background: rgba(244, 114, 182, 0.1); }
        .upload-box input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        .bg-options { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .bg-btn { aspect-ratio: 1; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
        .bg-btn.active { border-color: white; transform: scale(1.1); }
        .bg-trans { background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); background-size: 10px 10px; background-color: #fff; }

        .btn-action {
            margin-top: auto; padding: 15px; border: none; border-radius: 8px;
            background: linear-gradient(135deg, var(--accent), #db2777);
            color: white; font-weight: 800; cursor: pointer; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-action:disabled { background: #334155; opacity: 0.5; cursor: not-allowed; }

        .main-view { position: relative; background: #020617; display: flex; align-items: center; justify-content: center; background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 20px 20px; overflow: hidden; }
        
        #result-img { max-width: 90%; max-height: 90%; display: none; object-fit: contain; }
        
        .loader { position: absolute; inset: 0; background: rgba(15,23,42,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 50; }
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="title"><i class="fas fa-magic"></i> ERASER PRO</div>
        
        <div class="upload-box">
            <i class="fas fa-cloud-upload-alt" style="font-size: 1.5rem; color: #94a3b8; margin-bottom: 5px;"></i>
            <span style="font-size: 0.7rem; color: #cbd5e1; font-weight: 700;">SUBIR IMAGEN</span>
            <input type="file" accept="image/*" onchange="processImage(this)">
        </div>

        <div>
            <div style="font-size:0.7rem; font-weight:700; color:#94a3b8; margin-bottom:5px;">FONDO</div>
            <div class="bg-options">
                <div class="bg-btn bg-trans active" onclick="setBg('trans', this)"></div>
                <div class="bg-btn" style="background:#fff" onclick="setBg('#fff', this)"></div>
                <div class="bg-btn" style="background:#000" onclick="setBg('#000', this)"></div>
                <div class="bg-btn" style="background:#f472b6" onclick="setBg('#f472b6', this)"></div>
                <div class="bg-btn" style="background:#22c55e" onclick="setBg('#22c55e', this)"></div>
            </div>
        </div>

        <div style="font-size:0.7rem; color:#94a3b8; margin-top:10px;">
            Estado: <span id="status" style="color:#fbbf24;">Esperando...</span>
        </div>

        <button id="btn-dl" class="btn-action" disabled onclick="downloadImg()">
            <i class="fas fa-download"></i> DESCARGAR
        </button>
    </div>

    <div class="main-view" id="canvas-area">
        <div id="placeholder" style="text-align:center; opacity:0.3;">
            <i class="fas fa-image" style="font-size:4rem; margin-bottom:10px;"></i>
            <div>Sube una foto</div>
        </div>
        <img id="result-img" src="">
        
        <div class="loader" id="loader">
            <div class="spinner"></div>
            <div id="loader-txt" style="font-weight:700; font-size:0.9rem;">PROCESANDO...</div>
        </div>
    </div>
</div>

<script type="module">
    import imglyRemoveBackground from 'https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.3.0/dist/browser/index.min.js';

    window.finalBlob = null;
    let currentBg = 'trans';

    // Hacer la función global para el HTML
    window.processImage = async function(input) {
        if (!input.files[0]) return;
        const file = input.files[0];

        const loader = document.getElementById('loader');
        const txt = document.getElementById('loader-txt');
        loader.style.display = 'flex';
        
        try {
            txt.innerText = "Descargando IA (Solo la 1ra vez)...";
            
            // CONFIGURACIÓN CLAVE: CDN PÚBLICO
            // Esto es lo que permite que funcione en GitHub sin subir modelos
            const config = {
                publicPath: 'https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.3.0/dist/',
                progress: (key, current, total) => {
                    if(key.includes('model')) {
                        const p = Math.round((current/total)*100);
                        txt.innerText = `Cargando Cerebro: ${p}%`;
                    }
                }
            };

            const blob = await imglyRemoveBackground(file, config);
            
            // Mostrar resultado
            window.finalBlob = blob;
            const url = URL.createObjectURL(blob);
            document.getElementById('result-img').src = url;
            document.getElementById('result-img').style.display = 'block';
            document.getElementById('placeholder').style.display = 'none';
            
            document.getElementById('status').innerText = "Listo ✅";
            document.getElementById('status').style.color = "#4ade80";
            document.getElementById('btn-dl').disabled = false;

        } catch (error) {
            console.error(error);
            alert("Error: " + error);
        } finally {
            loader.style.display = 'none';
        }
    };

    window.setBg = function(color, el) {
        currentBg = color;
        document.querySelectorAll('.bg-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        
        const area = document.getElementById('canvas-area');
        if(color === 'trans') {
            area.style.background = '#020617 radial-gradient(#334155 1px, transparent 1px)';
            area.style.backgroundSize = '20px 20px';
        } else {
            area.style.background = color;
        }
    }

    window.downloadImg = function() {
        if(!window.finalBlob) return;
        
        if(currentBg === 'trans') {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(window.finalBlob);
            a.download = "sin-fondo.png";
            a.click();
        } else {
            // Combinar con fondo
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.fillStyle = currentBg;
                ctx.fillRect(0,0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = "con-fondo.png";
                a.click();
            };
            img.src = URL.createObjectURL(window.finalBlob);
        }
    }
</script>
</body>
</html>