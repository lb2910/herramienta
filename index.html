<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Optimizer - Ultimate</title>
    
    <script src="https://cdn.jsdelivr.net/npm/gifuct-js@2.1.2/dist/gifuct-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

    <style>
        /* --- ESTILOS --- */
        body { 
            background: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; 
            margin: 0; padding: 20px; display: flex; justify-content: center; 
        }
        
        #app {
            background: #1e293b; width: 100%; max-width: 900px; 
            border-radius: 16px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid #334155;
        }

        .header {
            background: linear-gradient(90deg, #6366f1, #ec4899);
            padding: 20px; text-align: center;
        }
        .header h1 { margin: 0; font-size: 24px; font-weight: 900; letter-spacing: 1px; }

        .grid { display: flex; flex-wrap: wrap; }
        .panel { padding: 25px; flex: 1; min-width: 300px; }
        .left { border-right: 1px solid #334155; }

        /* UPLOAD */
        .upload-box {
            border: 2px dashed #6366f1; background: rgba(99, 102, 241, 0.1);
            border-radius: 12px; height: 100px; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; transition: 0.3s;
            flex-direction: column; color: #a5b4fc; font-weight: bold;
        }
        .upload-box:hover { background: rgba(99, 102, 241, 0.2); }
        .upload-box.ready { border-color: #10b981; background: rgba(16, 185, 129, 0.1); color: #10b981; }

        /* CONTROLS */
        .control-group { margin-top: 20px; }
        label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 5px; font-weight: bold; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #ec4899; }
        
        .btn-process {
            background: #ec4899; color: white; border: none; padding: 15px; 
            width: 100%; border-radius: 50px; font-weight: bold; font-size: 16px; 
            margin-top: 25px; cursor: pointer; transition: 0.2s;
            opacity: 0.5; pointer-events: none; /* Desactivado al inicio */
        }
        .btn-process.active { opacity: 1; pointer-events: all; }
        .btn-process:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(236, 72, 153, 0.4); }

        /* PREVIEW */
        .preview-area {
            background: #020617; border-radius: 12px; min-height: 250px; 
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #334155; overflow: hidden; position: relative;
        }
        .preview-area img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .stats { margin-top: 15px; font-size: 13px; color: #94a3b8; display: flex; justify-content: space-between; }
        .stat-val { color: #fff; font-weight: bold; }
        .stat-save { color: #10b981; font-weight: bold; }

        .btn-download {
            background: #10b981; color: white; border: none; padding: 10px 20px;
            border-radius: 8px; font-weight: bold; margin-top: 15px; width: 100%;
            cursor: pointer; display: none;
        }

        /* LOG BOX */
        #log-console {
            width: 100%; height: 60px; background: #000; color: #0f0; 
            font-family: monospace; font-size: 10px; border: none; 
            padding: 10px; margin-top: 20px; resize: none; border-radius: 8px;
        }

        /* --- PANTALLA DE CARGA (OVERLAY) --- */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: none; /* Oculto por defecto */
            flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .spinner {
            width: 60px; height: 60px; border: 6px solid rgba(255,255,255,0.1);
            border-top-color: #ec4899; border-radius: 50%;
            animation: spin 1s infinite linear; margin-bottom: 20px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-text { font-size: 18px; font-weight: bold; color: white; letter-spacing: 1px; }
        .loading-sub { font-size: 14px; color: #94a3b8; margin-top: 5px; }

    </style>
</head>
<body>

<div id="overlay">
    <div class="spinner"></div>
    <div class="loading-text">PROCESANDO GIF...</div>
    <div class="loading-sub">Por favor espera, no cierres la pesta√±a.</div>
</div>

<div id="app">
    <div class="header">
        <h1>‚ö° OPTIMIZADOR GIF PRO</h1>
    </div>
    
    <div class="grid">
        <div class="panel left">
            <input type="file" id="inp-file" accept="image/gif" hidden onchange="handleUpload(this)">
            <div class="upload-box" id="drop-zone" onclick="document.getElementById('inp-file').click()">
                <span style="font-size: 24px">üìÇ</span>
                <span id="lbl-upload">Clic para subir GIF</span>
            </div>

            <div class="control-group">
                <label>ESCALA (Tama√±o): <span id="lbl-scale" style="color:#ec4899">70%</span></label>
                <input type="range" id="rng-scale" min="30" max="100" value="70" oninput="updateUI()">
            </div>

            <div class="control-group">
                <label>CALIDAD (10 = Balanceado): <span id="lbl-qual" style="color:#ec4899">10</span></label>
                <input type="range" id="rng-qual" min="1" max="30" value="10" oninput="updateUI()">
            </div>

            <button class="btn-process" id="btn-go" onclick="triggerProcess()">üöÄ REDUCIR PESO</button>

            <textarea id="log-console" readonly>Esperando archivo...</textarea>
        </div>

        <div class="panel">
            <label>RESULTADO:</label>
            <div class="preview-area" id="preview-container">
                <span style="opacity:0.3">La vista previa aparecer√° aqu√≠</span>
            </div>
            
            <div class="stats">
                <div>Original: <span id="stat-orig" class="stat-val">-</span></div>
                <div>Nuevo: <span id="stat-new" class="stat-val">-</span></div>
            </div>
            <div style="text-align:right; margin-top:5px; font-size:12px;">
                Ahorro: <span id="stat-save" class="stat-save">0%</span>
            </div>

            <button class="btn-download" id="btn-dl" onclick="downloadFile()">‚¨áÔ∏è DESCARGAR GIF</button>
        </div>
    </div>
</div>

<script>
    // --- VARIABLES GLOBALES ---
    let originalFile = null;
    let parsedFrames = [];
    let resultBlob = null;
    
    // --- UI HELPERS ---
    function log(msg) {
        const c = document.getElementById('log-console');
        const time = new Date().toLocaleTimeString();
        c.value = `[${time}] ${msg}\n` + c.value;
    }

    function updateUI() {
        document.getElementById('lbl-scale').innerText = document.getElementById('rng-scale').value + "%";
        document.getElementById('lbl-qual').innerText = document.getElementById('rng-qual').value;
    }

    function formatBytes(bytes) {
        if (!bytes) return '0 B';
        const k = 1024;
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + ['B', 'KB', 'MB', 'GB'][i];
    }

    // --- 1. SUBIR Y ANALIZAR GIF ---
    function handleUpload(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        
        if (file.type !== 'image/gif') { alert("‚ùå Solo se admiten GIFs"); return; }

        originalFile = file;
        log(`Cargando: ${file.name} (${formatBytes(file.size)})`);

        // UI Updates
        document.getElementById('lbl-upload').innerText = "‚úÖ GIF CARGADO";
        document.getElementById('drop-zone').classList.add('ready');
        document.getElementById('stat-orig').innerText = formatBytes(file.size);
        
        // Mostrar preview original
        document.getElementById('preview-container').innerHTML = `<img src="${URL.createObjectURL(file)}">`;

        // Pre-parsear frames (Lector)
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                // Usamos la librer√≠a gifuct-js
                const gif = parseGIF(e.target.result);
                parsedFrames = gif.decompressFrames(true);
                log(`‚úÖ Frames analizados: ${parsedFrames.length}`);
                
                // Activar bot√≥n
                document.getElementById('btn-go').classList.add('active');
            } catch (err) {
                log("‚ùå Error leyendo frames: " + err);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // --- 2. ACTIVAR EL PROCESO (TRUCO DEL DELAY) ---
    function triggerProcess() {
        if (parsedFrames.length === 0) return;

        // 1. Mostrar pantalla de carga
        document.getElementById('overlay').style.display = 'flex';
        log("Iniciando motor gr√°fico...");

        // 2. Esperar 100ms para que el navegador dibuje el overlay antes de congelarse
        setTimeout(() => {
            runOptimization();
        }, 100);
    }

    // --- 3. PROCESAMIENTO REAL ---
    function runOptimization() {
        try {
            const scale = parseInt(document.getElementById('rng-scale').value) / 100;
            const quality = parseInt(document.getElementById('rng-qual').value);

            // --- HACK PARA WORKER SIN CORS ---
            // Creamos un Blob con el c√≥digo del worker que importa el script de CDN
            const workerCode = `importScripts('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');`;
            const workerBlob = new Blob([workerCode], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(workerBlob);

            // Configurar GIF.js
            const gif = new GIF({
                workers: 2,
                quality: quality,
                width: parsedFrames[0].dims.width * scale,
                height: parsedFrames[0].dims.height * scale,
                workerScript: workerUrl, // Usamos nuestro worker local
                transparent: 'rgba(0,0,0,0)'
            });

            // Preparar Canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            log(`Procesando ${parsedFrames.length} frames al ${scale*100}%...`);

            // Loop de frames
            parsedFrames.forEach(frame => {
                // Dibujar frame original
                tempCanvas.width = frame.dims.width;
                tempCanvas.height = frame.dims.height;
                const imgData = new ImageData(frame.patch, frame.dims.width, frame.dims.height);
                tempCtx.putImageData(imgData, 0, 0);

                // Escalar
                canvas.width = frame.dims.width * scale;
                canvas.height = frame.dims.height * scale;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);

                // A√±adir al GIF nuevo
                gif.addFrame(ctx, {copy: true, delay: frame.delay});
            });

            // Al terminar
            gif.on('finished', function(blob) {
                log("‚úÖ ¬°Proceso terminado!");
                resultBlob = blob;
                
                // Mostrar resultado
                const url = URL.createObjectURL(blob);
                document.getElementById('preview-container').innerHTML = `<img src="${url}">`;
                
                // Actualizar stats
                document.getElementById('stat-new').innerText = formatBytes(blob.size);
                const saved = ((originalFile.size - blob.size) / originalFile.size * 100).toFixed(0);
                const badge = document.getElementById('stat-save');
                badge.innerText = saved > 0 ? `-${saved}%` : '+0%';
                
                // Mostrar bot√≥n descarga y ocultar carga
                document.getElementById('btn-dl').style.display = 'block';
                document.getElementById('overlay').style.display = 'none';
            });

            // Renderizar
            gif.render();

        } catch (err) {
            log("‚ùå ERROR CR√çTICO: " + err.message);
            alert("Error: " + err.message);
            document.getElementById('overlay').style.display = 'none';
        }
    }

    // --- 4. DESCARGAR ---
    function downloadFile() {
        if (!resultBlob) return;
        const a = document.createElement('a');
        a.href = URL.createObjectURL(resultBlob);
        a.download = 'gif-optimizado.gif';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
