<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Compressor - V13 (Multi-Server)</title>
    
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 600px; width: 100%; background: #1e293b; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .status-bar { display: flex; gap: 10px; margin-bottom: 20px; background: #000; padding: 10px; border-radius: 8px; font-size: 12px; font-family: monospace; }
        .light { display: flex; align-items: center; gap: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #ef4444; } 
        .dot.ok { background: #22c55e; box-shadow: 0 0 5px #22c55e; } 
        .dot.warn { background: #f59e0b; box-shadow: 0 0 5px #f59e0b; }

        .upload-box { 
            border: 2px dashed #6366f1; padding: 40px; text-align: center; cursor: pointer; 
            border-radius: 8px; margin-bottom: 20px; transition: 0.3s; background: rgba(99, 102, 241, 0.1); font-weight: bold;
        }
        .upload-box:hover { background: rgba(99, 102, 241, 0.2); }

        .controls { opacity: 0.5; pointer-events: none; transition: 0.3s; }
        .controls.active { opacity: 1; pointer-events: all; }

        input[type=range] { width: 100%; margin: 10px 0 20px 0; accent-color: #8b5cf6; }
        
        button {
            background: #8b5cf6; color: white; border: none; padding: 15px; width: 100%;
            border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer;
        }
        button:hover { background: #7c3aed; }

        #log-box { 
            width: 100%; height: 100px; background: #000; color: #00ff00; 
            font-family: monospace; font-size: 11px; padding: 10px; 
            border: 1px solid #333; margin-top: 20px; overflow-y: scroll; box-sizing: border-box;
        }
        
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 999;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
            border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s infinite linear;
        }
        @keyframes spin { to {transform: rotate(360deg);} }

        #preview-img { max-width: 100%; margin-top: 20px; border: 1px solid #333; display: none; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/omggif/1.0.10/omggif.min.js"></script>

</head>
<body>

<div id="overlay">
    <div class="spinner"></div>
    <h3 style="margin-top:20px">Procesando...</h3>
</div>

<div class="container">
    <h2>GIF OPTIMIZER V13</h2>
    
    <div class="status-bar">
        <div class="light"><div id="dot-1" class="dot"></div> Lector</div>
        <div class="light"><div id="dot-2" class="dot"></div> Escritor</div>
        <div class="light"><div id="dot-3" class="dot"></div> Worker</div>
    </div>

    <input type="file" id="fileIn" accept="image/gif" hidden onchange="handleUpload(this)">
    <div class="upload-box" onclick="document.getElementById('fileIn').click()">
        üìÇ SUBIR GIF AQU√ç
    </div>

    <div class="controls" id="ctrls">
        <label>ESCALA: <span id="v-scale">70%</span></label>
        <input type="range" id="rng-scale" min="30" max="100" value="70" oninput="updateUI()">
        
        <label>CALIDAD (10): <span id="v-qual">10</span></label>
        <input type="range" id="rng-qual" min="1" max="20" value="10" oninput="updateUI()">
        
        <button onclick="triggerProcess()">üöÄ PROCESAR</button>
    </div>

    <img id="preview-img" src="">
    <div id="stats" style="margin-top:10px; font-weight:bold; color:#22c55e;"></div>
    
    <button id="btn-dl" style="display:none; margin-top:10px; background:#22c55e" onclick="download()">‚¨áÔ∏è DESCARGAR</button>

    <div id="log-box">Iniciando sistema...</div>
</div>

<script>
    // --- VARIABLES ---
    let originalFile = null;
    let gifReader = null; 
    let resultBlob = null;
    let workerUrl = null;
    let OmggifLib = null; // Guardar√° la referencia correcta

    function log(msg) {
        const b = document.getElementById('log-box');
        b.innerHTML = `> ${msg}<br>` + b.innerHTML;
    }

    function updateUI() {
        document.getElementById('v-scale').innerText = document.getElementById('rng-scale').value + "%";
        document.getElementById('v-qual').innerText = document.getElementById('rng-qual').value;
    }

    // --- CARGA DE LIBRER√çAS DE EMERGENCIA ---
    async function loadBackupLibrary() {
        log("‚ö†Ô∏è CDNJS fall√≥. Intentando servidor de respaldo (UNPKG)...");
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/omggif@1.0.10/omggif.min.js';
            script.onload = () => resolve(true);
            script.onerror = () => reject(false);
            document.head.appendChild(script);
        });
    }

    // --- 1. VERIFICACI√ìN Y CORRECCI√ìN (AL INICIO) ---
    window.onload = async function() {
        
        // --- PARTE A: REPARAR LECTOR (Omggif) ---
        // A veces carga como 'Omggif', a veces como 'omggif' (min√∫scula)
        if(typeof Omggif !== 'undefined') {
            OmggifLib = Omggif;
        } else if (typeof omggif !== 'undefined') {
            OmggifLib = omggif;
        } else {
            // Si fall√≥ CDNJS, intentamos el respaldo
            try {
                await loadBackupLibrary();
                if(typeof Omggif !== 'undefined') OmggifLib = Omggif;
                else if (typeof omggif !== 'undefined') OmggifLib = omggif;
            } catch(e) {
                log("‚ùå ERROR FATAL: No se pudo cargar el Lector desde ning√∫n servidor.");
            }
        }

        if(OmggifLib) {
            document.getElementById('dot-1').classList.add('ok');
            log("‚úÖ Lector cargado correctamente.");
        } else {
            log("‚ùå ERROR: El Lector no est√° disponible.");
        }

        // --- PARTE B: ESCRITOR (gif.js) ---
        if(typeof GIF !== 'undefined') {
            document.getElementById('dot-2').classList.add('ok');
            log("‚úÖ Escritor cargado.");
            
            // PRE-CARGAR WORKER
            try {
                log("üîÑ Preparando Worker...");
                const resp = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                if(!resp.ok) throw new Error("Red bloqueada");
                const txt = await resp.text();
                const blob = new Blob([txt], {type: 'application/javascript'});
                workerUrl = URL.createObjectURL(blob);
                document.getElementById('dot-3').classList.add('ok');
                log("‚úÖ Worker listo en memoria.");
            } catch(e) {
                log("‚ö†Ô∏è Worker remoto fall√≥. Usando modo lento.");
                document.getElementById('dot-3').classList.add('warn');
            }
        } else {
            log("‚ùå ERROR: Escritor no carg√≥.");
        }
    };

    // --- 2. LECTURA ---
    function handleUpload(input) {
        if(!input.files[0]) return;
        if(!OmggifLib) { alert("La librer√≠a de lectura no carg√≥. Recarga la p√°gina."); return; }
        
        originalFile = input.files[0];
        log(`üìÇ Archivo: ${originalFile.name}`);

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const u8Array = new Uint8Array(e.target.result);
                // Usamos la referencia corregida OmggifLib
                gifReader = new OmggifLib.GifReader(u8Array);
                
                log(`‚úÖ Frames: ${gifReader.numFrames()} | Tama√±o: ${gifReader.width}x${gifReader.height}`);
                document.getElementById('ctrls').classList.add('active');
            } catch(err) {
                log(`‚ùå Error leyendo GIF: ${err.message}`);
                alert("El archivo no es v√°lido o est√° da√±ado.");
            }
        };
        reader.readAsArrayBuffer(originalFile);
    }

    // --- 3. PROCESAMIENTO ---
    function triggerProcess() {
        document.getElementById('overlay').style.display = 'flex';
        setTimeout(runEngine, 100);
    }

    function runEngine() {
        try {
            const scale = parseInt(document.getElementById('rng-scale').value) / 100;
            const quality = parseInt(document.getElementById('rng-qual').value);
            
            const newWidth = Math.floor(gifReader.width * scale);
            const newHeight = Math.floor(gifReader.height * scale);

            // Configuraci√≥n del GIF nuevo
            const gifConfig = {
                workers: 2,
                quality: quality,
                width: newWidth,
                height: newHeight,
                transparent: 'rgba(0,0,0,0)'
            };
            
            // Si logramos cargar el worker local, lo usamos. Si no, gif.js intentar√° buscarlo.
            if(workerUrl) gifConfig.workerScript = workerUrl;

            const gif = new GIF(gifConfig);

            // Canvas
            const canvas = document.createElement('canvas');
            canvas.width = newWidth;
            canvas.height = newHeight;
            const ctx = canvas.getContext('2d');

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = gifReader.width;
            tempCanvas.height = gifReader.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            const pixels = new Uint8ClampedArray(gifReader.width * gifReader.height * 4);

            log(`Procesando ${gifReader.numFrames()} frames...`);

            for(let i=0; i < gifReader.numFrames(); i++) {
                // Decodificar frame (Librer√≠a Omggif)
                gifReader.decodeAndBlitFrameRGBA(i, pixels);
                
                const imgData = new ImageData(pixels, gifReader.width, gifReader.height);
                tempCtx.putImageData(imgData, 0, 0);

                // Escalar
                ctx.clearRect(0, 0, newWidth, newHeight);
                ctx.drawImage(tempCanvas, 0, 0, newWidth, newHeight);

                // Agregar
                const frameInfo = gifReader.frameInfo(i);
                // Omggif usa cent√©simas de segundo, gif.js usa milisegundos (x10)
                gif.addFrame(ctx, {copy: true, delay: frameInfo.delay * 10}); 
            }

            gif.on('finished', (blob) => {
                resultBlob = blob;
                const url = URL.createObjectURL(blob);
                const img = document.getElementById('preview-img');
                img.src = url;
                img.style.display = 'block';
                
                const saved = ((originalFile.size - blob.size) / originalFile.size * 100).toFixed(0);
                document.getElementById('stats').innerText = `Peso Final: ${(blob.size/1024).toFixed(1)} KB (Ahorro: ${saved}%)`;
                
                document.getElementById('btn-dl').style.display = 'block';
                document.getElementById('overlay').style.display = 'none';
                log("‚ú® ¬°PROCESO FINALIZADO!");
            });

            log("Generando archivo...");
            gif.render();

        } catch(e) {
            document.getElementById('overlay').style.display = 'none';
            log(`‚ùå CRASH: ${e.message}`);
            alert("Error: " + e.message);
        }
    }

    function download() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(resultBlob);
        a.download = 'optimizado.gif';
        a.click();
    }
</script>

</body>
</html>
