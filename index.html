<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF Compressor - V11 (Fix CDN)</title>
    
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { max-width: 600px; width: 100%; background: #1e293b; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* SEM√ÅFOROS DE ESTADO */
        .status-bar { display: flex; gap: 10px; margin-bottom: 20px; background: #000; padding: 10px; border-radius: 8px; font-size: 12px; font-family: monospace; }
        .light { display: flex; align-items: center; gap: 5px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #ef4444; } /* Rojo por defecto */
        .dot.ok { background: #22c55e; box-shadow: 0 0 5px #22c55e; } /* Verde OK */

        .upload-box { 
            border: 2px dashed #6366f1; padding: 40px; text-align: center; cursor: pointer; 
            border-radius: 8px; margin-bottom: 20px; transition: 0.3s; background: rgba(99, 102, 241, 0.1); font-weight: bold;
        }
        .upload-box:hover { background: rgba(99, 102, 241, 0.2); }

        .controls { opacity: 0.5; pointer-events: none; transition: 0.3s; }
        .controls.active { opacity: 1; pointer-events: all; }

        input[type=range] { width: 100%; margin: 10px 0 20px 0; accent-color: #8b5cf6; }
        
        button {
            background: #8b5cf6; color: white; border: none; padding: 15px; width: 100%;
            border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer;
        }
        button:hover { background: #7c3aed; }

        #log-box { 
            width: 100%; height: 100px; background: #000; color: #00ff00; 
            font-family: monospace; font-size: 11px; padding: 10px; 
            border: 1px solid #333; margin-top: 20px; overflow-y: scroll; box-sizing: border-box;
        }

        #preview-img { max-width: 100%; margin-top: 20px; border: 1px solid #333; display: none; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/gifuct-js@2.1.2/dist/gifuct-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

</head>
<body>

<div class="container">
    <h2>GIF OPTIMIZER V11 (JSDelivr)</h2>
    
    <div class="status-bar">
        <div class="light"><div id="dot-1" class="dot"></div> Lib: Lector</div>
        <div class="light"><div id="dot-2" class="dot"></div> Lib: Escritor</div>
        <div class="light"><div id="dot-3" class="dot"></div> Worker</div>
    </div>

    <input type="file" id="fileIn" accept="image/gif" hidden onchange="handleUpload(this)">
    <div class="upload-box" onclick="document.getElementById('fileIn').click()">
        üìÇ TOCAR AQU√ç PARA SUBIR
    </div>

    <div class="controls" id="ctrls">
        <label>ESCALA: <span id="v-scale">70%</span></label>
        <input type="range" id="rng-scale" min="30" max="100" value="70" oninput="updateUI()">
        
        <label>CALIDAD (10): <span id="v-qual">10</span></label>
        <input type="range" id="rng-qual" min="1" max="20" value="10" oninput="updateUI()">
        
        <button onclick="processGIF()">üöÄ PROCESAR AHORA</button>
    </div>

    <img id="preview-img" src="">
    <div id="stats" style="margin-top:10px; font-weight:bold; color:#22c55e;"></div>
    
    <button id="btn-dl" style="display:none; margin-top:10px; background:#22c55e" onclick="download()">‚¨áÔ∏è DESCARGAR</button>

    <div id="log-box">Iniciando sistema...</div>
</div>

<script>
    // --- VARIABLES ---
    let originalFile = null;
    let originalFrames = [];
    let resultBlob = null;
    let workerUrl = null;

    function log(msg) {
        const b = document.getElementById('log-box');
        b.innerHTML = `> ${msg}<br>` + b.innerHTML;
    }

    function updateUI() {
        document.getElementById('v-scale').innerText = document.getElementById('rng-scale').value + "%";
        document.getElementById('v-qual').innerText = document.getElementById('rng-qual').value;
    }

    // --- 1. VERIFICACI√ìN DE LIBRER√çAS (AL INICIO) ---
    window.onload = async function() {
        // Chequeo gifuct-js
        if(typeof parseGIF !== 'undefined') {
            document.getElementById('dot-1').classList.add('ok');
            log("‚úÖ Librer√≠a de Lectura (jsDelivr) cargada.");
        } else {
            log("‚ùå ERROR CR√çTICO: No carg√≥ gifuct-js. Intenta recargar la p√°gina.");
        }

        // Chequeo gif.js
        if(typeof GIF !== 'undefined') {
            document.getElementById('dot-2').classList.add('ok');
            log("‚úÖ Librer√≠a de Escritura cargada.");
            
            // PRE-CARGAR WORKER
            try {
                log("üîÑ Descargando Worker...");
                const resp = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                if(!resp.ok) throw new Error("Error HTTP " + resp.status);
                const txt = await resp.text();
                const blob = new Blob([txt], {type: 'application/javascript'});
                workerUrl = URL.createObjectURL(blob);
                document.getElementById('dot-3').classList.add('ok');
                log("‚úÖ Worker listo en memoria.");
            } catch(e) {
                log("‚ùå ERROR Worker: " + e.message);
            }

        } else {
            log("‚ùå ERROR: No carg√≥ gif.js.");
        }
    };

    // --- 2. SUBIDA ---
    function handleUpload(input) {
        if(!input.files[0]) return;
        const file = input.files[0];
        if(file.type !== 'image/gif') { alert("Solo GIF"); return; }
        
        originalFile = file;
        log(`üìÇ Archivo seleccionado: ${file.name}`);

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                if(typeof parseGIF === 'undefined') throw new Error("Librer√≠a de lectura ausente.");
                
                const gif = parseGIF(e.target.result);
                originalFrames = gif.decompressFrames(true);
                log(`‚úÖ GIF analizado correctamente: ${originalFrames.length} frames.`);
                
                document.getElementById('ctrls').classList.add('active');
            } catch(err) {
                log(`‚ùå Error leyendo GIF: ${err.message}`);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // --- 3. PROCESO ---
    function processGIF() {
        if(!workerUrl) { alert("El sistema no est√° listo (Worker no carg√≥)."); return; }
        
        log("üöÄ Iniciando compresi√≥n...");
        const scale = parseInt(document.getElementById('rng-scale').value) / 100;
        const quality = parseInt(document.getElementById('rng-qual').value);

        try {
            const gif = new GIF({
                workers: 2,
                quality: quality,
                width: originalFrames[0].dims.width * scale,
                height: originalFrames[0].dims.height * scale,
                workerScript: workerUrl,
                transparent: 'rgba(0,0,0,0)'
            });

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const temp = document.createElement('canvas');
            const tctx = temp.getContext('2d');

            originalFrames.forEach(frame => {
                temp.width = frame.dims.width;
                temp.height = frame.dims.height;
                const imgData = new ImageData(frame.patch, frame.dims.width, frame.dims.height);
                tctx.putImageData(imgData, 0, 0);

                canvas.width = frame.dims.width * scale;
                canvas.height = frame.dims.height * scale;
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(temp, 0, 0, canvas.width, canvas.height);

                gif.addFrame(ctx, {copy: true, delay: frame.delay});
            });

            gif.on('finished', (blob) => {
                resultBlob = blob;
                const url = URL.createObjectURL(blob);
                const img = document.getElementById('preview-img');
                img.src = url;
                img.style.display = 'block';
                
                const saved = ((originalFile.size - blob.size) / originalFile.size * 100).toFixed(0);
                document.getElementById('stats').innerText = `Ahorro: ${saved}% (${(blob.size/1024).toFixed(1)} KB)`;
                
                document.getElementById('btn-dl').style.display = 'block';
                log("‚ú® PROCESO TERMINADO CON √âXITO.");
            });

            log("Renderizando...");
            gif.render();

        } catch(e) {
            log(`‚ùå CRASH: ${e.message}`);
        }
    }

    function download() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(resultBlob);
        a.download = 'optimizado.gif';
        a.click();
    }
</script>

</body>
</html>
